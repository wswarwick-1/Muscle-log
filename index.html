<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Training Log</title>

<style>
body { background:#2f2f2f; color:#fff; font-family:system-ui; margin:0 }
header { background:#1f1f1f; padding:14px; display:flex; justify-content:space-between }
header span,a { color:#f2c94c; font-weight:700; text-decoration:none }
.card { background:#3a3a3a; margin:14px; padding:14px; border-radius:14px }
label { color:#f2c94c; font-weight:600 }
select,input,button {
  width:100%; padding:12px; margin-top:8px;
  border-radius:10px; border:none; font-size:16px;
  background:#222; color:#fff
}
button { background:#444; color:#f2c94c; font-weight:700 }
.timer { font-size:32px; text-align:center; margin:10px 0 }
</style>
</head>

<body>

<header>
  <span>training log</span>
  <a href="log.html">log</a>
</header>

<div class="card">
  <label>Current Exercise</label>
  <div id="currentExercise">None</div>
  <div>PR: <span id="pr">—</span></div>
  <div>Last: <span id="last">—</span></div>
  <div>Set: <span id="setCount">0</span></div>
</div>

<div class="card">
  <label>Workout</label>
  <select id="workoutSelect"></select>
</div>

<div class="card">
  <label>Exercise</label>
  <select id="exerciseSelect"></select>
  <input id="customExercise" placeholder="Or type custom exercise">
  <button onclick="useCustomExercise()">Use custom exercise</button>
</div>

<div class="card">
  <label>Log Set</label>
  <input id="weight" type="number" placeholder="Weight (kg)">
  <input id="reps" type="number" placeholder="Reps">
  <button onclick="saveSet()">Save Set</button>
</div>

<div class="card">
  <label>Rest Timer (seconds)</label>
  <input id="restInput" type="number" value="90">
  <div class="timer" id="timer">00:00</div>
  <button onclick="startTimer()">Start</button>
  <button onclick="resetTimer()">Reset</button>
</div>

<div class="card">
  <label>Create Custom Workout</label>
  <input id="newWorkoutName" placeholder="Workout name">
  <input id="newExercise" placeholder="Exercise name">
  <button onclick="addExercise()">Add Exercise</button>
  <div id="builder"></div>
  <button onclick="saveWorkout()">Save Workout</button>
</div>

<audio id="beep">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=">
</audio>

<script>
/* ---------- SAFE INITIALISATION ---------- */
const DEFAULT_WORKOUTS = {
  Push:["Bench Press","OHP","Dips"],
  Pull:["Row","Pull-up","Lat Pulldown"],
  Legs:["Squat","RDL","Leg Press"]
};

let workouts = JSON.parse(localStorage.getItem("workouts"));
if (!workouts) {
  workouts = DEFAULT_WORKOUTS;
  localStorage.setItem("workouts", JSON.stringify(workouts));
}

let logs = JSON.parse(localStorage.getItem("logs")) || [];
let prs  = JSON.parse(localStorage.getItem("prs")) || {};

let currentWorkout = null;
let currentExercise = null;
let setCount = 0;
let builderBuffer = [];

/* ---------- ELEMENTS ---------- */
const workoutSelect = document.getElementById("workoutSelect");
const exerciseSelect = document.getElementById("exerciseSelect");

/* ---------- INIT ---------- */
function renderWorkouts() {
  workoutSelect.innerHTML = "<option value=''>Select workout</option>";
  Object.keys(workouts).forEach(w=>{
    workoutSelect.innerHTML += `<option value="${w}">${w}</option>`;
  });
}
renderWorkouts();

/* ---------- WORKOUT ---------- */
workoutSelect.onchange = () => {
  currentWorkout = workoutSelect.value;
  exerciseSelect.innerHTML = "<option value=''>Select exercise</option>";
  if (!currentWorkout) return;
  workouts[currentWorkout].forEach(e=>{
    exerciseSelect.innerHTML += `<option value="${e}">${e}</option>`;
  });
};

exerciseSelect.onchange = () => setExercise(exerciseSelect.value);

function useCustomExercise(){
  const ex = customExercise.value.trim();
  if(!ex) return;
  setExercise(ex);
  customExercise.value="";
}

function setExercise(ex){
  currentExercise = ex;
  setCount = 0;
  document.getElementById("currentExercise").innerText = ex;
  document.getElementById("setCount").innerText = "0";

  const last = logs.filter(l=>l.exercise===ex).slice(-1)[0];
  document.getElementById("last").innerText =
    last ? `${last.weight}kg x ${last.reps}` : "—";

  const pr = prs[ex];
  document.getElementById("pr").innerText =
    pr ? `${pr.weight}kg x ${pr.reps}` : "—";
}

/* ---------- LOG SET ---------- */
function saveSet(){
  if(!currentWorkout || !currentExercise) return alert("Select workout & exercise");

  const w = +weight.value;
  const r = +reps.value;
  if(!w || !r) return;

  setCount++;
  document.getElementById("setCount").innerText = setCount;

  logs.push({
    date:new Date().toISOString().slice(0,10),
    workout:currentWorkout,
    exercise:currentExercise,
    weight:w,
    reps:r
  });
  localStorage.setItem("trainingLogs", JSON.stringify(logs));

  if(!prs[currentExercise] || w > prs[currentExercise].weight){
    prs[currentExercise] = {weight:w,reps:r};
    localStorage.setItem("prs", JSON.stringify(prs));
  }

  document.getElementById("last").innerText = `${w}kg x ${r}`;
  document.getElementById("pr").innerText =
    `${prs[currentExercise].weight}kg x ${prs[currentExercise].reps}`;

  weight.value = reps.value = "";
}

/* ---------- TIMER ---------- */
let tInt;
function startTimer(){
  let t = +restInput.value;
  clearInterval(tInt);
  updateTimer(t);
  tInt = setInterval(()=>{
    t--;
    updateTimer(t);
    if(t<=0){
      clearInterval(tInt);
      navigator.vibrate?.(300);
      beep.play().catch(()=>{});
    }
  },1000);
}
function resetTimer(){
  clearInterval(tInt);
  timer.innerText="00:00";
}
function updateTimer(t){
  timer.innerText =
    String(Math.floor(t/60)).padStart(2,"0")+":"+
    String(t%60).padStart(2,"0");
}

/* ---------- CUSTOM WORKOUT ---------- */
function addExercise(){
  const ex = newExercise.value.trim();
  if(!ex) return;
  builderBuffer.push(ex);
  newExercise.value="";
  builder.innerHTML = builderBuffer.join("<br>");
}

function saveWorkout(){
  const name = newWorkoutName.value.trim();
  if(!name || builderBuffer.length===0) return alert("Name + exercises required");

  workouts[name] = [...builderBuffer];
  localStorage.setItem("workouts", JSON.stringify(workouts));

  builderBuffer=[];
  newWorkoutName.value="";
  builder.innerHTML="";
  renderWorkouts();
}
</script>

</body>
</html>

